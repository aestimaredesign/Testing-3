<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Electrical Boxes & Covers Estimator – NEC 2023 Compliant with Multi-Wire Box Fill Calculations">
    <meta name="author" content="AestimareDesign">
    <title>Professional Electrical Boxes & Covers Estimator | Multi-Wire NEC 2023 Compliant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --success: #27ae60;
        --warning: #e67e22;
        --danger: #e0392b;
        --light: #ecf0f1;
        --dark: #2c3e50;
        --text-dark: #2c3e50;
        --text-medium: #5d6d7e;
        --text-light: #7f8c8d;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--text-dark);
        background-color: #f8f9fa;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }

    header {
        background: var(--primary);
        color: white;
        padding: 1rem 0;
        margin-bottom: 2rem;
        border-radius: 8px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
    }

    h1 {
        font-size: 2rem;
        font-weight: 600;
    }

    .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: var(--secondary);
        color: white;
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.85rem;
    }

    .btn:hover, .btn:focus {
        opacity: 0.9;
        transform: translateY(-1px);
        outline: 2px solid var(--secondary);
        outline-offset: 2px;
    }

    .calculator-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 2rem;
    }

    @media (max-width: 1024px) {
        .calculator-grid {
            grid-template-columns: 1fr;
        }
    }

    .input-section, .output-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--light);
        color: var(--primary);
    }

    .input-group {
        margin-bottom: 1rem;
    }

    .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
        align-items: end;
    }

    .input-row-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
        align-items: end;
    }

    .input-row-dynamic {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr auto;
        gap: 10px;
        margin-bottom: 10px;
        align-items: end;
    }

    .input-row-circuit {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;
        gap: 8px;
        margin-bottom: 10px;
        align-items: end;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-dark);
    }

    input, select, textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    textarea {
        min-height: 80px;
        resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--secondary);
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .work-item {
        background: var(--light);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border-left: 4px solid var(--secondary);
    }

    .work-item-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bill-of-quantity-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .bill-of-quantity-table th,
    .bill-of-quantity-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .bill-of-quantity-table th {
        background: var(--primary);
        color: white;
        font-weight: 600;
    }

    .bill-of-quantity-table tr:hover {
        background-color: #f5f5f5;
    }

    .total-row {
        font-weight: 600;
        background-color: var(--light) !important;
    }

    .text-right {
        text-align: right;
    }

    .text-center {
        text-align: center;
    }

    .cost-breakdown {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 1rem;
    }

    .cost-card {
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-top: 4px solid var(--secondary);
    }

    .cost-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary);
        margin: 10px 0;
    }

    .cost-category {
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }

    .category-header {
        background: #f5f5f5;
        padding: 12px 15px;
        font-weight: bold;
        border-bottom: 1px solid #e0e0e0;
    }

    .category-items {
        padding: 15px;
    }

    .category-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px dashed #f0f0f0;
    }

    .category-total {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid #e0e0e0;
        font-weight: bold;
    }

    .grand-total {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        text-align: center;
    }

    .grand-total .cost-value {
        color: white;
        font-size: 2rem;
    }

    .validation-error {
        color: var(--danger);
        font-size: 0.875rem;
        margin-top: 5px;
        display: none;
    }

    .tab-container {
        margin-bottom: 1rem;
    }

    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
    }

    .tab.active {
        border-bottom-color: var(--secondary);
        color: var(--secondary);
        font-weight: 600;
    }

    .tab.focus {
        outline: 2px solid var(--secondary);
        outline-offset: -2px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .unit-label {
        font-size: 0.8rem;
        color: var(--text-medium);
        margin-top: 2px;
    }

    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: var(--dark);
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    .crew-sizing {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid var(--success);
    }

    .crew-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .crew-option {
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }

    .bill-of-quantity-table td:nth-child(3),
    .bill-of-quantity-table td:nth-child(5),
    .bill-of-quantity-table td:nth-child(6),
    .bill-of-quantity-table td:nth-child(7),
    .bill-of-quantity-table td:nth-child(8),
    .bill-of-quantity-table th:nth-child(8) { text-align: right; }
    .bill-of-quantity-table td:nth-child(1),
    .bill-of-quantity-table td:nth-child(4) { text-align: center; }

    .hidden {
        display: none;
    }

    .remove-btn {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 0.85rem;
    }

    .remove-btn:hover, .remove-btn:focus {
        opacity: 0.9;
        outline: 2px solid var(--danger);
        outline-offset: 2px;
    }

    .input-error {
        border-color: var(--danger) !important;
        box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.2) !important;
    }

    .error-message {
        color: var(--danger);
        font-size: 0.75rem;
        margin-top: 3px;
        display: none;
    }

    /* NEC Box Fill Styles */
    .nec-box-fill {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
    }

    .nec-result {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: 600;
    }

    .nec-pass {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        color: #2e7d32;
    }

    .nec-fail {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #c62828;
    }

    .nec-warning {
        background: #fff3e0;
        border: 1px solid #ff9800;
        color: #ef6c00;
    }

    .conductor-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 0.9em;
    }

    .conductor-table th, .conductor-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    .conductor-table th {
        background: #f5f5f5;
    }

    /* Circuit specific styles */
    .circuit-item {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .circuit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .circuit-title {
        font-weight: 600;
        color: var(--primary);
    }

    .circuit-wire-size {
        background: var(--secondary);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }

    .circuit-summary {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
    }

    .circuit-totals {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .circuit-total-item {
        text-align: center;
        padding: 8px;
        background: white;
        border-radius: 4px;
    }

    /* Help section backgrounds */
    .help-section {
        margin-bottom: 25px;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .how-to-use {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 4px solid #2196f3;
    }

    .calculation-formulas {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border-left: 4px solid #4caf50;
    }

    .standard-sizes {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-left: 4px solid #ff9800;
    }

    .step-guide p {
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
    }

    .step-number {
        display: inline-block;
        background: var(--secondary);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .formula-box, .reference-box {
        padding: 15px;
        background: rgba(255,255,255,0.7);
        border-radius: 6px;
        margin-top: 10px;
    }

    .formula-box h4, .reference-box h4 {
        margin-top: 15px;
        margin-bottom: 8px;
        color: var(--primary);
    }

    .formula-box p, .reference-box ul {
        margin-bottom: 8px;
        color: var(--text-dark);
    }

    .reference-box ul {
        padding-left: 20px;
    }

    /* NEC Details indentation */
    .nec-details ul {
        padding-left: 20px;
        margin-bottom: 10px;
    }

    .nec-details li {
        margin-bottom: 5px;
    }

    /* Procurement styles */
    .procurement-note {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 0.9em;
    }

    /* Scope checklist */
    .scope-checklist {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
    }

    .checklist-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .checklist-item input {
        width: auto;
        margin-right: 10px;
        margin-top: 3px;
    }

    /* Test cases */
    .test-cases {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border-left: 4px solid #9c27b0;
    }

    .test-case {
        background: rgba(255,255,255,0.7);
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 4px solid #7b1fa2;
    }

    /* Accessibility improvements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .skip-link {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--secondary);
        color: white;
        padding: 8px;
        z-index: 100;
        text-decoration: none;
        border-radius: 4px;
    }

    .skip-link:focus {
        top: 6px;
    }

    /* Focus indicators */
    *:focus {
        outline: 2px solid var(--secondary);
        outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        :root {
            --primary: #000000;
            --secondary: #0000ff;
            --success: #008000;
            --warning: #ffa500;
            --danger: #ff0000;
            --text-dark: #000000;
            --text-medium: #000000;
            --text-light: #000000;
        }
        
        .unit-label {
            font-weight: bold;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
    </style>
</head>
<body>
<a href="#main-content" class="skip-link">Skip to main content</a>

<div class="container">
    <header>
        <div class="header-content">
            <h1>Professional Electrical Boxes & Covers Estimator</h1>
            <div class="controls">
                <button class="btn btn-success" id="exportPdfBtn" aria-label="Export results as PDF document">Export PDF</button>
                <button class="btn btn-success" id="exportExcelBtn" aria-label="Export results as Excel spreadsheet">Export Excel</button>
                <button class="btn btn-danger" id="resetBtn" aria-label="Reset all inputs and calculations">Reset</button>
            </div>
        </div>
    </header>

    <main id="main-content">
        <div class="calculator-grid">
            <div class="input-section">
                <!-- ALL PREVIOUS INPUT SECTIONS REMAIN THE SAME - I'm omitting for brevity -->
                <!-- The entire input section from the previous code should be here -->
                <!-- ... -->
                
                <!-- Add new input fields for indirect costs -->
                <div class="tab-content active" id="general-tab" role="tabpanel" aria-labelledby="tab-general">
                    <!-- Previous inputs remain... -->
                    
                    <div class="work-item" style="margin-top: 20px;">
                        <div class="work-item-title">
                            <span>Indirect Cost Parameters</span>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="tempFacilitiesRate" class="tooltip">Temporary Facilities (%)<span class="tooltiptext">Percentage for temporary site facilities</span></label>
                                <input type="number" id="tempFacilitiesRate" value="2" step="0.1" min="0" max="20" aria-describedby="tempFacilitiesRateDesc">
                                <div class="error-message" id="tempFacilitiesRateError">Must be between 0-20%</div>
                                <div id="tempFacilitiesRateDesc" class="sr-only">Percentage for temporary site facilities</div>
                            </div>
                            <div class="input-group">
                                <label for="powerConsumptionRate" class="tooltip">Power Consumption (%)<span class="tooltiptext">Percentage for power consumption</span></label>
                                <input type="number" id="powerConsumptionRate" value="1.5" step="0.1" min="0" max="10" aria-describedby="powerConsumptionRateDesc">
                                <div class="error-message" id="powerConsumptionRateError">Must be between 0-10%</div>
                                <div id="powerConsumptionRateDesc" class="sr-only">Percentage for power consumption</div>
                            </div>
                            <div class="input-group">
                                <label for="waterConsumptionRate" class="tooltip">Water Consumption (%)<span class="tooltiptext">Percentage for water consumption</span></label>
                                <input type="number" id="waterConsumptionRate" value="0.5" step="0.1" min="0" max="5" aria-describedby="waterConsumptionRateDesc">
                                <div class="error-message" id="waterConsumptionRateError">Must be between 0-5%</div>
                                <div id="waterConsumptionRateDesc" class="sr-only">Percentage for water consumption</div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="permitsTaxesRate" class="tooltip">Permits & Taxes (%)<span class="tooltiptext">Percentage for permits and taxes</span></label>
                                <input type="number" id="permitsTaxesRate" value="3" step="0.1" min="0" max="15" aria-describedby="permitsTaxesRateDesc">
                                <div class="error-message" id="permitsTaxesRateError">Must be between 0-15%</div>
                                <div id="permitsTaxesRateDesc" class="sr-only">Percentage for permits and taxes</div>
                            </div>
                            <div class="input-group">
                                <label for="safetyServicesRate" class="tooltip">Safety/Sanitation/Security (%)<span class="tooltiptext">Percentage for safety, sanitation, and security services</span></label>
                                <input type="number" id="safetyServicesRate" value="2.5" step="0.1" min="0" max="10" aria-describedby="safetyServicesRateDesc">
                                <div class="error-message" id="safetyServicesRateError">Must be between 0-10%</div>
                                <div id="safetyServicesRateDesc" class="sr-only">Percentage for safety, sanitation, and security services</div>
                            </div>
                            <div class="input-group">
                                <label for="bondsInsurancesRate" class="tooltip">Bonds & Insurances (%)<span class="tooltiptext">Percentage for bonds and insurances</span></label>
                                <input type="number" id="bondsInsurancesRate" value="1.5" step="0.1" min="0" max="10" aria-describedby="bondsInsurancesRateDesc">
                                <div class="error-message" id="bondsInsurancesRateError">Must be between 0-10%</div>
                                <div id="bondsInsurancesRateDesc" class="sr-only">Percentage for bonds and insurances</div>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="asBuiltPlansRate" class="tooltip">As-Built Plans (%)<span class="tooltiptext">Percentage for as-built plans and documentation</span></label>
                                <input type="number" id="asBuiltPlansRate" value="1" step="0.1" min="0" max="5" aria-describedby="asBuiltPlansRateDesc">
                                <div class="error-message" id="asBuiltPlansRateError">Must be between 0-5%</div>
                                <div id="asBuiltPlansRateDesc" class="sr-only">Percentage for as-built plans and documentation</div>
                            </div>
                            <div class="input-group">
                                <label for="deliveryHaulingRate" class="tooltip">Delivery & Hauling (%)<span class="tooltiptext">Percentage for delivery and hauling charges</span></label>
                                <input type="number" id="deliveryHaulingRate" value="1.5" step="0.1" min="0" max="10" aria-describedby="deliveryHaulingRateDesc">
                                <div class="error-message" id="deliveryHaulingRateError">Must be between 0-10%</div>
                                <div id="deliveryHaulingRateDesc" class="sr-only">Percentage for delivery and hauling charges</div>
                            </div>
                            <div class="input-group">
                                <label for="contingencyRate" class="tooltip">Contingency (%)<span class="tooltiptext">Percentage for contingency costs</span></label>
                                <input type="number" id="contingencyRate" value="5" step="0.1" min="0" max="20" aria-describedby="contingencyRateDesc">
                                <div class="error-message" id="contingencyRateError">Must be between 0-20%</div>
                                <div id="contingencyRateDesc" class="sr-only">Percentage for contingency costs</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="circuit-summary">
                        <h4>Circuit Summary</h4>
                        <div id="circuitSummaryContent">
                            <p>No circuits defined yet. Add circuits in the Circuit Types tab.</p>
                        </div>
                    </div>
                </div>
                
                <!-- ... rest of the input sections ... -->
                
                <div class="input-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="calculateBtn" style="width: 100%; padding: 12px; font-size: 1.1rem;">Calculate</button>
                </div>
            </div>
            <div class="output-section">
                <h2 class="section-title">Multi-Wire Estimate Results</h2>
                <div id="necComplianceWarning" class="nec-result nec-warning hidden">
                    <strong>NEC Compliance Warning:</strong> Some box types may not meet NEC requirements. Review details below.
                </div>
                
                <div class="work-item">
                    <div class="work-item-title">
                        <span>Circuit Summary</span>
                    </div>
                    <div id="circuitResultsSummary">
                        <p>Circuit breakdown will appear here after calculation.</p>
                    </div>
                </div>
                
                <div class="work-item">
                    <div class="work-item-title">
                        <span>Bill of Quantities</span>
                    </div>
                    <table class="bill-of-quantity-table" id="billOfQuantity">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Unit Cost</th>
                                <th>Material Cost</th>
                                <th>Labor Cost</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="5">TOTAL</td>
                                <td id="totalMaterialCost" class="text-right">-</td>
                                <td id="totalLaborCost" class="text-right">-</td>
                                <td id="totalCostColumn" class="text-right">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="work-item">
                    <div class="work-item-title">
                        <span>Cost Breakdown</span>
                    </div>
                    
                    <!-- DIRECT COST CATEGORY -->
                    <div class="cost-category" style="border-top-color: #3498db;">
                        <div class="category-header" style="background: #e3f2fd; color: #1565c0;">
                            DIRECT COSTS
                        </div>
                        <div class="category-items">
                            <div class="category-item">
                                <span>Material Cost</span>
                                <span id="materialCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Labor Cost</span>
                                <span id="laborCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-total">
                                <span>TOTAL DIRECT COST</span>
                                <span id="totalDirectCostDisplay" style="font-weight: bold; color: #1565c0;">PHP 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INDIRECT COST CATEGORY -->
                    <div class="cost-category" style="border-top-color: #ff9800; margin-top: 20px;">
                        <div class="category-header" style="background: #fff3e0; color: #ef6c00;">
                            INDIRECT COSTS
                        </div>
                        <div class="category-items">
                            <div class="category-item">
                                <span>Equipment Cost</span>
                                <span id="equipmentCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Transportation Cost</span>
                                <span id="transportationCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Temporary Facilities</span>
                                <span id="tempFacilitiesCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Power Consumption</span>
                                <span id="powerConsumptionCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Water Consumption</span>
                                <span id="waterConsumptionCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Permits & Taxes</span>
                                <span id="permitsTaxesCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Safety/Sanitation/Security</span>
                                <span id="safetyServicesCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Bonds & Insurances</span>
                                <span id="bondsInsurancesCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>As-Built Plans</span>
                                <span id="asBuiltPlansCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Delivery & Hauling Charges</span>
                                <span id="deliveryHaulingCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Contingency Cost</span>
                                <span id="contingencyCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-item">
                                <span>Overhead Rate</span>
                                <span id="overheadCostDisplay">PHP 0.00</span>
                            </div>
                            <div class="category-total">
                                <span>TOTAL INDIRECT COST</span>
                                <span id="totalIndirectCostDisplay" style="font-weight: bold; color: #ef6c00;">PHP 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GRAND TOTAL (Direct + Indirect) -->
                    <div class="cost-category" style="border-top-color: #4caf50; margin-top: 20px;">
                        <div class="category-header" style="background: #e8f5e8; color: #2e7d32;">
                            GRAND TOTAL (Direct + Indirect Costs)
                        </div>
                        <div class="category-items">
                            <div class="category-total" style="border-top: none; padding-top: 0;">
                                <span>Direct + Indirect Costs</span>
                                <span id="grandTotalDisplay" style="font-weight: bold; font-size: 1.2em; color: #2e7d32;">PHP 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PROFIT MARGIN -->
                    <div class="cost-category" style="border-top-color: #9c27b0; margin-top: 20px;">
                        <div class="category-header" style="background: #f3e5f5; color: #7b1fa2;">
                            PROFIT MARGIN
                        </div>
                        <div class="category-items">
                            <div class="category-total" style="border-top: none; padding-top: 0;">
                                <span>Profit Margin (Applied on Grand Total)</span>
                                <span id="profitCostDisplay" style="font-weight: bold; color: #7b1fa2;">PHP 0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PROJECTED BUDGET -->
                    <div class="grand-total" style="margin-top: 20px;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">PROJECTED BUDGET</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Direct Cost + Indirect Cost + Profit Margin</div>
                        <div id="projectedBudgetDisplay" class="cost-value">PHP 0.00</div>
                        <div class="currency-display">PHP</div>
                    </div>
                </div>
                
                <div class="work-item">
                    <div class="work-item-title">
                        <span>Project Summary</span>
                    </div>
                    <div class="input-row-2">
                        <div class="input-group">
                            <label>Total Boxes</label>
                            <input type="text" id="totalBoxes" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="input-group">
                            <label>Total Labor Hours</label>
                            <input type="text" id="totalLaborHours" readonly style="background-color: #f8f9fa;">
                        </div>
                    </div>
                    <div class="input-row-2">
                        <div class="input-group">
                            <label>Project Duration (Standard Crew)</label>
                            <input type="text" id="projectDuration" readonly style="background-color: #f8f9fa;">
                        </div>
                        <div class="input-group">
                            <label>Cost per Box</label>
                            <input type="text" id="costPerBox" readonly style="background-color: #f8f9fa;">
                        </div>
                    </div>
                </div>
                
                <div class="work-item">
                    <div class="work-item-title">
                        <span>Procurement Summary</span>
                    </div>
                    <table class="bill-of-quantity-table" id="procurementTable">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty Needed</th>
                                <th>Packaging</th>
                                <th>Units to Order</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4">TOTAL PROCUREMENT COST</td>
                                <td id="totalProcurementCost" class="text-right">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="work-item">
                    <div class="work-item-title">
                        <span>NEC Compliance Summary</span>
                    </div>
                    <div id="necComplianceSummary">
                        <p>NEC compliance details will appear here after calculation.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Global variables
    let projectData = {};
    let circuitNecResults = {};

    // Enhanced Box Capacities with NEC-driven selection
    const BOX_CAPACITIES = {
        'Utility Box (Standard)': { volume: 18.0, costMultiplier: 1.0, description: 'Standard Utility Box' },
        'Utility Box (Deep)': { volume: 22.5, costMultiplier: 1.2, description: 'Deep Utility Box' },
        '4x4 Junction Box (1.5")': { volume: 21.0, costMultiplier: 1.0, description: '4x4" Junction Box (1.5" deep)' },
        '4x4 Junction Box (2.125")': { volume: 30.3, costMultiplier: 1.4, description: '4x4" Junction Box (2.125" deep)' },
        '4x4 Square Box (1.5")': { volume: 21.0, costMultiplier: 1.0, description: '4x4" Square Box (1.5" deep)' },
        '4x4 Square Box (2.125")': { volume: 30.3, costMultiplier: 1.4, description: '4x4" Square Box (2.125" deep)' },
        'Two Gang Box (Standard)': { volume: 30.0, costMultiplier: 1.0, description: 'Two Gang Box (Standard)' },
        'Two Gang Box (Deep)': { volume: 42.0, costMultiplier: 1.3, description: 'Two Gang Box (Deep)' }
    };

    // Box type mappings for NEC-driven selection
    const BOX_TYPE_MAPPINGS = {
        'Utility Box (Standard)': 'Utility Box (Deep)',
        '4x4 Junction Box (1.5")': '4x4 Junction Box (2.125")',
        '4x4 Square Box (1.5")': '4x4 Square Box (2.125")',
        'Two Gang Box (Standard)': 'Two Gang Box (Deep)'
    };

    // Set default date to today
    document.getElementById('projectDate').valueAsDate = new Date();
    
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
            });
            
            // Activate clicked tab
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');
            const tabId = this.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
        
        // Keyboard navigation for tabs
        tab.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // Utility functions
    function safeNumber(v, fallback = 0) {
        if (v === "" || v === null || v === undefined) return fallback;
        const n = Number(v);
        return isNaN(n) ? fallback : n;
    }

    function formatNumber(num, dp = 2) {
        if (typeof num !== 'number' || isNaN(num)) return "0.00";
        const rounded = Math.round((num + Number.EPSILON) * Math.pow(10, dp)) / Math.pow(10, dp);
        return rounded.toLocaleString(undefined, { minimumFractionDigits: dp, maximumFractionDigits: dp });
    }

    function formatCurrency(amount, symbol = null) {
        if (symbol === null) {
            symbol = getCurrencySymbol();
        }
        if (typeof amount !== 'number' || isNaN(amount)) return symbol + ' 0.00';
        return symbol + ' ' + formatNumber(amount, 2);
    }
    
    // Update currency displays
    function updateCurrencyDisplays() {
        const currency = document.getElementById('currency').value;
        let symbol = "";
        switch (currency) {
            case 'PHP': symbol = 'PHP'; break;
            case 'USD': symbol = '$'; break;
            case 'EUR': symbol = '€'; break;
            case 'JPY': symbol = '¥'; break;
            default: symbol = currency;
        }
        
        // Update all currency displays
        document.querySelectorAll('.currency-display').forEach(el => {
            el.textContent = symbol;
        });
        
        // Update input labels
        document.querySelectorAll('.currency-unit').forEach(el => {
            el.textContent = symbol;
        });
    }
    
    // Initial currency update
    updateCurrencyDisplays();
    
    // Currency change listener
    document.getElementById('currency').addEventListener('change', updateCurrencyDisplays);
    
    // Circuit Management
    function addCircuit() {
        const container = document.getElementById('circuitsContainer');
        const circuitId = 'circuit_' + Date.now();
        
        const circuitHTML = `
            <div class="input-row-circuit circuit-item" id="${circuitId}">
                <div class="input-group">
                    <input type="text" class="circuit-description" placeholder="e.g., Lighting Circuits" value="Lighting Circuits">
                </div>
                <div class="input-group">
                    <select class="circuit-wire-size">
                        <option value="14">14 AWG</option>
                        <option value="12" selected>12 AWG</option>
                        <option value="10">10 AWG</option>
                        <option value="8">8 AWG</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="number" class="circuit-percentage" value="40" min="0" max="100" step="1">
                    <div class="unit-label">%</div>
                </div>
                <div class="input-group">
                    <input type="number" class="circuit-conductors" value="4" min="0" step="1">
                    <div class="unit-label">pcs</div>
                </div>
                <div class="input-group">
                    <input type="number" class="circuit-devices" value="1" min="0" step="1">
                    <div class="unit-label">pcs</div>
                </div>
                <div class="input-group">
                    <input type="number" class="circuit-clamps" value="2" min="0" step="1">
                    <div class="unit-label">pcs</div>
                </div>
                <div class="input-group">
                    <button class="remove-btn" type="button" onclick="removeCircuit('${circuitId}')" aria-label="Remove this circuit">Remove</button>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', circuitHTML);
        
        // Add event listeners to update totals
        const newCircuit = document.getElementById(circuitId);
        const inputs = newCircuit.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', updateCircuitTotals);
        });
        
        const select = newCircuit.querySelector('select');
        select.addEventListener('change', updateCircuitTotals);
        
        updateCircuitTotals();
    }
    
    function removeCircuit(id) {
        const element = document.getElementById(id);
        if (element) {
            element.remove();
            updateCircuitTotals();
        }
    }
    
    function updateCircuitTotals() {
        const circuits = document.querySelectorAll('.circuit-item');
        let totalPercentage = 0;
        
        circuits.forEach(circuit => {
            const percentage = safeNumber(circuit.querySelector('.circuit-percentage').value);
            totalPercentage += percentage;
        });
        
        document.getElementById('circuitDistributionTotal').value = totalPercentage.toFixed(1) + '%';
        
        // Update total boxes preview
        const wallArea = safeNumber(document.getElementById('wallArea').value);
        const density = safeNumber(document.getElementById('density').value);
        const totalBoxes = wallArea * density;
        document.getElementById('circuitTotalBoxes').value = Math.round(totalBoxes) + ' boxes';
        
        const errorElement = document.getElementById('circuitDistributionError');
        if (Math.abs(totalPercentage - 100) > 0.1) {
            errorElement.textContent = 'Circuit percentages must add up to 100% (Current: ' + totalPercentage.toFixed(1) + '%)';
            errorElement.style.display = 'block';
            return false;
        } else {
            errorElement.style.display = 'none';
            return true;
        }
    }
    
    // Add initial circuit
    document.getElementById('addCircuitBtn').addEventListener('click', addCircuit);
    
    // Distribution validation
    function validateDistribution() {
        const pctJunc = safeNumber(document.getElementById('pctJunc').value);
        const pctUtil = safeNumber(document.getElementById('pctUtil').value);
        const pctSq = safeNumber(document.getElementById('pctSq').value);
        const pctPull = safeNumber(document.getElementById('pctPull').value);
        const pctGutter = safeNumber(document.getElementById('pctGutter').value);
        const pctWire4 = safeNumber(document.getElementById('pctWire4').value);
        const pctWire6 = safeNumber(document.getElementById('pctWire6').value);
        const pctWire8 = safeNumber(document.getElementById('pctWire8').value);
        
        const total = pctJunc + pctUtil + pctSq + pctPull + pctGutter + pctWire4 + pctWire6 + pctWire8;
        document.getElementById('distributionTotal').value = total.toFixed(1) + '%';
        
        const errorElement = document.getElementById('distributionError');
        if (Math.abs(total - 100) > 0.1) {
            errorElement.textContent = 'Distribution percentages must add up to 100% (Current: ' + total.toFixed(1) + '%)';
            errorElement.style.display = 'block';
            return false;
        } else {
            errorElement.style.display = 'none';
            return true;
        }
    }
    
    // Add distribution validation to percentage inputs
    const percentageInputs = ['pctJunc', 'pctUtil', 'pctSq', 'pctPull', 'pctGutter', 'pctWire4', 'pctWire6', 'pctWire8'];
    percentageInputs.forEach(id => {
        document.getElementById(id).addEventListener('input', validateDistribution);
    });
    
    // Add circuit percentage validation to wall area and density
    document.getElementById('wallArea').addEventListener('input', updateCircuitTotals);
    document.getElementById('density').addEventListener('input', updateCircuitTotals);
    
    // CORRECTED NEC Box Fill Calculation for Circuits
    function calculateNECBoxFillForCircuit(circuitData) {
        const conductorSize = parseInt(circuitData.wireSize, 10);
        const currentConductors = safeNumber(circuitData.conductors);
        const groundingConductors = 1; // Always count as one per NEC
        const devicesCount = safeNumber(circuitData.devices);
        const cableClamps = safeNumber(circuitData.clamps);
        const pigtails = 2; // Standard assumption
        const safetyFactor = 0.20; // 20% safety factor

        const conductorVolumes = { 18:1.5, 16:1.75, 14:2.0, 12:2.25, 10:2.5, 8:3.0, 6:5.0 };
        const volPerConductor = conductorVolumes[conductorSize] || conductorVolumes[12];

        // NEC counting:
        const currentVolume = (currentConductors + pigtails) * volPerConductor;
        const groundVolume = volPerConductor; // counts as ONE equivalent
        const deviceVolume = devicesCount * 2 * volPerConductor;
        const clampVolume = cableClamps * volPerConductor;

        const totalVolumeRequired = currentVolume + groundVolume + deviceVolume + clampVolume;
        const volumeWithSafety = totalVolumeRequired * (1 + safetyFactor);

        // Find suitable box sizes
        const suitableBoxes = Object.entries(BOX_CAPACITIES)
            .filter(([boxName, boxData]) => boxData.volume >= volumeWithSafety)
            .sort((a, b) => a[1].volume - b[1].volume);

        const smallestSuitableBox = suitableBoxes[0];
        const isCompliant = smallestSuitableBox != undefined;

        const necResult = {
            conductorSize,
            currentConductors,
            pigtails,
            groundingConductors,
            devicesCount,
            cableClamps,
            volPerConductor,
            currentVolume,
            groundVolume,
            deviceVolume,
            clampVolume,
            totalVolumeRequired,
            volumeWithSafety,
            safetyFactor: safetyFactor * 100,
            requiredBoxVolume: volumeWithSafety,
            smallestSuitableBox: smallestSuitableBox ? smallestSuitableBox[0] : null,
            smallestSuitableBoxVolume: smallestSuitableBox ? smallestSuitableBox[1].volume : null,
            isCompliant,
            suitableBoxes
        };

        return necResult;
    }
    
    // Get NEC-compliant box selection and costs for circuits
    function getNECCompliantBoxesForCircuit(necResult) {
        if (!necResult) return {};
        
        const requiredVolume = necResult.volumeWithSafety;
        const boxUpgrades = {};
        
        // Check each standard box type and upgrade if necessary
        Object.entries(BOX_CAPACITIES).forEach(([boxName, boxData]) => {
            // If this box type doesn't meet requirements, check if there's an upgrade available
            if (boxData.volume < requiredVolume && BOX_TYPE_MAPPINGS[boxName]) {
                const upgradedBox = BOX_TYPE_MAPPINGS[boxName];
                const upgradedBoxData = BOX_CAPACITIES[upgradedBox];
                
                if (upgradedBoxData && upgradedBoxData.volume >= requiredVolume) {
                    boxUpgrades[boxName] = upgradedBox;
                }
            }
        });
        
        return boxUpgrades;
    }
    
    // Currency formatting functions
    function getCurrencySymbol() {
        const currency = document.getElementById('currency').value;
        switch (currency) {
            case 'USD': return '$';
            case 'EUR': return '€';
            case 'JPY': return '¥';
            default: return 'PHP';
        }
    }

    function updateBOQTable(circuitResults, totalOutlets, data, worstCaseCircuit, currencySymbol) {
        const boqTable = document.getElementById('billOfQuantity');
        
        // Determine box descriptions based on NEC upgrades
        const juncDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['4x4 Junction Box (1.5")'] ? 
            BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['4x4 Junction Box (1.5")']].description : '4x4" Junction Box';
        const utilDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['Utility Box (Standard)'] ? 
            BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['Utility Box (Standard)']].description : 'Standard Utility Box';
        const sqDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['4x4 Square Box (1.5")'] ? 
            BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['4x4 Square Box (1.5")']].description : '4x4" Square Box';
        
        boqTable.innerHTML = `
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Unit</th>
                    <th>Unit Cost</th>
                    <th>Material Cost</th>
                    <th>Labor Cost</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Junction Box</td>
                    <td>${juncDescription}</td>
                    <td>${data.qtyJunc}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costJunc, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostJunc, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyJunc / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostJunc + (data.qtyJunc / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Utility Box</td>
                    <td>${utilDescription}</td>
                    <td>${data.qtyUtil}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costUtil, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostUtil, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyUtil / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostUtil + (data.qtyUtil / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Square Box</td>
                    <td>${sqDescription}</td>
                    <td>${data.qtySq}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costSq, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostSq, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtySq / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostSq + (data.qtySq / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Pull Box</td>
                    <td>8x8" Pull Box</td>
                    <td>${data.qtyPull}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costPull, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostPull, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyPull / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostPull + (data.qtyPull / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Gutter</td>
                    <td>Wire Gutter</td>
                    <td>${data.qtyGutter}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costGutter, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostGutter, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyGutter / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostGutter + (data.qtyGutter / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Closed Nipple</td>
                    <td>1/2" Closed Nipple</td>
                    <td>${data.qtyNip}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costNip, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostNip, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyNip / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostNip + (data.qtyNip / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Wireway 4x4</td>
                    <td>4x4" Wireway</td>
                    <td>${data.qtyWire4}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costWire4, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire4, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyWire4 / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire4 + (data.qtyWire4 / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Wireway 6x6</td>
                    <td>6x6" Wireway</td>
                    <td>${data.qtyWire6}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costWire6, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire6, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyWire6 / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire6 + (data.qtyWire6 / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Wireway 8x8</td>
                    <td>8x8" Wireway</td>
                    <td>${data.qtyWire8}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costWire8, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire8, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyWire8 / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire8 + (data.qtyWire8 / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Covers</td>
                    <td>Blank Covers</td>
                    <td>${data.qtyCover}</td>
                    <td>pc</td>
                    <td class="text-right">${formatCurrency(data.costCover, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostCover, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.qtyCover / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostCover + (data.qtyCover / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="5">TOTAL</td>
                    <td id="totalMaterialCost" class="text-right">${formatCurrency(data.materialCostJunc + data.materialCostUtil + data.materialCostSq + data.materialCostPull + data.materialCostGutter + data.materialCostNip + data.materialCostWire4 + data.materialCostWire6 + data.materialCostWire8 + data.materialCostCover, currencySymbol)}</td>
                    <td id="totalLaborCost" class="text-right">${formatCurrency((data.qtyJunc + data.qtyUtil + data.qtySq + data.qtyPull + data.qtyGutter + data.qtyNip + data.qtyWire4 + data.qtyWire6 + data.qtyWire8 + data.qtyCover) / data.productivity * data.laborRate, currencySymbol)}</td>
                    <td id="totalCostColumn" class="text-right">${formatCurrency((data.materialCostJunc + data.materialCostUtil + data.materialCostSq + data.materialCostPull + data.materialCostGutter + data.materialCostNip + data.materialCostWire4 + data.materialCostWire6 + data.materialCostWire8 + data.materialCostCover) + ((data.qtyJunc + data.qtyUtil + data.qtySq + data.qtyPull + data.qtyGutter + data.qtyNip + data.qtyWire4 + data.qtyWire6 + data.qtyWire8 + data.qtyCover) / data.productivity * data.laborRate), currencySymbol)}</td>
                </tr>
            </tfoot>
        `;
    }

    function updateProcurementTable(data, worstCaseCircuit, currencySymbol) {
        const procurementTable = document.getElementById('procurementTable');
        
        // Determine box descriptions based on NEC upgrades
        const juncDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['4x4 Junction Box (1.5")'] ? 
            BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['4x4 Junction Box (1.5")']].description : '4x4" Junction Box';
        const utilDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['Utility Box (Standard)'] ? 
            BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['Utility Box (Standard)']].description : 'Standard Utility Box';
        const sqDescription = worstCaseCircuit && worstCaseCircuit.boxUpgrades['4x4 Square Box (1.5")'] ? 
            BOX_CAPACITIES[worstCaseCircuit.boxUpgrades['4x4 Square Box (1.5")']].description : '4x4" Square Box';
        
        procurementTable.innerHTML = `
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty Needed</th>
                    <th>Packaging</th>
                    <th>Units to Order</th>
                    <th>Cost</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${juncDescription}</td>
                    <td>${data.qtyJunc}</td>
                    <td>Carton of 10</td>
                    <td>${Math.ceil(data.qtyJunc / 10)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostJunc, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>${utilDescription}</td>
                    <td>${data.qtyUtil}</td>
                    <td>Carton of 10</td>
                    <td>${Math.ceil(data.qtyUtil / 10)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostUtil, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>${sqDescription}</td>
                    <td>${data.qtySq}</td>
                    <td>Carton of 10</td>
                    <td>${Math.ceil(data.qtySq / 10)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostSq, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Pull Box</td>
                    <td>${data.qtyPull}</td>
                    <td>Individual</td>
                    <td>${data.qtyPull}</td>
                    <td class="text-right">${formatCurrency(data.materialCostPull, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Gutter</td>
                    <td>${data.qtyGutter}</td>
                    <td>Individual</td>
                    <td>${data.qtyGutter}</td>
                    <td class="text-right">${formatCurrency(data.materialCostGutter, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Closed Nipple</td>
                    <td>${data.qtyNip}</td>
                    <td>Box of 100</td>
                    <td>${Math.ceil(data.qtyNip / 100)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostNip, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Wireway 4x4</td>
                    <td>${data.qtyWire4}</td>
                    <td>Individual</td>
                    <td>${data.qtyWire4}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire4, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Wireway 6x6</td>
                    <td>${data.qtyWire6}</td>
                    <td>Individual</td>
                    <td>${data.qtyWire6}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire6, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Wireway 8x8</td>
                    <td>${data.qtyWire8}</td>
                    <td>Individual</td>
                    <td>${data.qtyWire8}</td>
                    <td class="text-right">${formatCurrency(data.materialCostWire8, currencySymbol)}</td>
                </tr>
                <tr>
                    <td>Covers</td>
                    <td>${data.qtyCover}</td>
                    <td>Carton of 25</td>
                    <td>${Math.ceil(data.qtyCover / 25)}</td>
                    <td class="text-right">${formatCurrency(data.materialCostCover, currencySymbol)}</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="4">TOTAL PROCUREMENT COST</td>
                    <td id="totalProcurementCost" class="text-right">${formatCurrency(data.totalMaterialCost, currencySymbol)}</td>
                </tr>
            </tfoot>
        `;
    }

    // Main calculation function - UPDATED FOR NEW COST BREAKDOWN
    function calculateEstimate() {
        console.log('Calculate button clicked');
        
        // Validate inputs first
        if (!validateInputs()) {
            console.log('Input validation failed');
            return;
        }

        // Validate circuits
        if (!validateCircuits()) {
            console.log('Circuit validation failed');
            return;
        }

        // Get circuit data
        const circuits = [];
        const circuitElements = document.querySelectorAll('.circuit-item');
        
        circuitElements.forEach(circuitElement => {
            const description = circuitElement.querySelector('.circuit-description').value;
            const wireSize = circuitElement.querySelector('.circuit-wire-size').value;
            const percentage = safeNumber(circuitElement.querySelector('.circuit-percentage').value) / 100;
            const conductors = safeNumber(circuitElement.querySelector('.circuit-conductors').value);
            const devices = safeNumber(circuitElement.querySelector('.circuit-devices').value);
            const clamps = safeNumber(circuitElement.querySelector('.circuit-clamps').value);
            
            circuits.push({
                description,
                wireSize,
                percentage,
                conductors,
                devices,
                clamps
            });
        });

        // Calculate total outlets
        const wallArea = parseFloat(document.getElementById('wallArea').value);
        const density = parseFloat(document.getElementById('density').value);
        const totalOutlets = wallArea * density;
        
        // Calculate boxes per circuit and NEC requirements
        let totalMaterialCost = 0;
        let totalLaborCost = 0;
        const circuitResults = [];
        circuitNecResults = {};

        circuits.forEach(circuit => {
            const circuitBoxes = Math.ceil(totalOutlets * circuit.percentage);
            const necResult = calculateNECBoxFillForCircuit(circuit);
            const boxUpgrades = getNECCompliantBoxesForCircuit(necResult);
            
            circuitNecResults[circuit.description] = {
                necResult,
                boxUpgrades,
                circuitBoxes
            };
            
            circuitResults.push({
                ...circuit,
                circuitBoxes,
                necResult,
                boxUpgrades
            });
        });

        // Update circuit summary in General tab
        updateCircuitSummary(circuitResults, totalOutlets);
        
        // Update NEC results in Circuits tab
        updateCircuitNecResults(circuitResults);

        // Get other input values
        const wastage = parseFloat(document.getElementById('wastage').value) / 100;
        const overheadRate = parseFloat(document.getElementById('overheadRate').value) / 100;
        const profitMarginRate = parseFloat(document.getElementById('profitMarginRate').value) / 100;
        const laborRate = parseFloat(document.getElementById('laborRate').value);
        const productivity = parseFloat(document.getElementById('productivity').value);
        const crewSize = parseFloat(document.getElementById('crewSize').value);
        const workHours = parseFloat(document.getElementById('workHours').value);
        
        // Get indirect cost rates
        const equipmentRate = parseFloat(document.getElementById('equipmentCost').value) / 100;
        const transportationRate = parseFloat(document.getElementById('transportationCost').value) / 100;
        const tempFacilitiesRate = parseFloat(document.getElementById('tempFacilitiesRate').value) / 100;
        const powerConsumptionRate = parseFloat(document.getElementById('powerConsumptionRate').value) / 100;
        const waterConsumptionRate = parseFloat(document.getElementById('waterConsumptionRate').value) / 100;
        const permitsTaxesRate = parseFloat(document.getElementById('permitsTaxesRate').value) / 100;
        const safetyServicesRate = parseFloat(document.getElementById('safetyServicesRate').value) / 100;
        const bondsInsurancesRate = parseFloat(document.getElementById('bondsInsurancesRate').value) / 100;
        const asBuiltPlansRate = parseFloat(document.getElementById('asBuiltPlansRate').value) / 100;
        const deliveryHaulingRate = parseFloat(document.getElementById('deliveryHaulingRate').value) / 100;
        const contingencyRate = parseFloat(document.getElementById('contingencyRate').value) / 100;
        
        // Get box distribution percentages
        const pctJunc = parseFloat(document.getElementById('pctJunc').value) / 100;
        const pctUtil = parseFloat(document.getElementById('pctUtil').value) / 100;
        const pctSq = parseFloat(document.getElementById('pctSq').value) / 100;
        const pctPull = parseFloat(document.getElementById('pctPull').value) / 100;
        const pctGutter = parseFloat(document.getElementById('pctGutter').value) / 100;
        const pctWire4 = parseFloat(document.getElementById('pctWire4').value) / 100;
        const pctWire6 = parseFloat(document.getElementById('pctWire6').value) / 100;
        const pctWire8 = parseFloat(document.getElementById('pctWire8').value) / 100;
        
        // Get base unit costs
        const baseCostJunc = parseFloat(document.getElementById('costJunc').value);
        const baseCostUtil = parseFloat(document.getElementById('costUtil').value);
        const baseCostSq = parseFloat(document.getElementById('costSq').value);
        const costPull = parseFloat(document.getElementById('costPull').value);
        const costGutter = parseFloat(document.getElementById('costGutter').value);
        const costNip = parseFloat(document.getElementById('costNip').value);
        const costWire4 = parseFloat(document.getElementById('costWire4').value);
        const costWire6 = parseFloat(document.getElementById('costWire6').value);
        const costWire8 = parseFloat(document.getElementById('costWire8').value);
        const costCover = parseFloat(document.getElementById('costCover').value);
        
        // Apply NEC-driven cost adjustments based on worst-case circuit
        let costJunc = baseCostJunc;
        let costUtil = baseCostUtil;
        let costSq = baseCostSq;
        
        let necAdjustments = [];
        
        // Find the circuit with the largest volume requirement
        let maxVolumeRequired = 0;
        let worstCaseCircuit = null;
        
        circuitResults.forEach(circuit => {
            if (circuit.necResult.volumeWithSafety > maxVolumeRequired) {
                maxVolumeRequired = circuit.necResult.volumeWithSafety;
                worstCaseCircuit = circuit;
            }
        });
        
        // Apply upgrades based on worst-case circuit
        if (worstCaseCircuit) {
            const worstCaseUpgrades = worstCaseCircuit.boxUpgrades;
            
            if (worstCaseUpgrades['Utility Box (Standard)']) {
                const upgradedBox = worstCaseUpgrades['Utility Box (Standard)'];
                costUtil = baseCostUtil * BOX_CAPACITIES[upgradedBox].costMultiplier;
                necAdjustments.push(`Utility boxes upgraded to ${upgradedBox} for ${worstCaseCircuit.description}`);
            }
            
            if (worstCaseUpgrades['4x4 Junction Box (1.5")']) {
                const upgradedBox = worstCaseUpgrades['4x4 Junction Box (1.5")'];
                costJunc = baseCostJunc * BOX_CAPACITIES[upgradedBox].costMultiplier;
                necAdjustments.push(`Junction boxes upgraded to ${upgradedBox} for ${worstCaseCircuit.description}`);
            }
            
            if (worstCaseUpgrades['4x4 Square Box (1.5")']) {
                const upgradedBox = worstCaseUpgrades['4x4 Square Box (1.5")'];
                costSq = baseCostSq * BOX_CAPACITIES[upgradedBox].costMultiplier;
                necAdjustments.push(`Square boxes upgraded to ${upgradedBox} for ${worstCaseCircuit.description}`);
            }
        }
        
        // Calculate quantities for each box type
        const qtyJunc = Math.ceil(totalOutlets * pctJunc);
        const qtyUtil = Math.ceil(totalOutlets * pctUtil);
        const qtySq = Math.ceil(totalOutlets * pctSq);
        const qtyPull = Math.ceil(totalOutlets * pctPull);
        const qtyGutter = Math.ceil(totalOutlets * pctGutter);
        const qtyWire4 = Math.ceil(totalOutlets * pctWire4);
        const qtyWire6 = Math.ceil(totalOutlets * pctWire6);
        const qtyWire8 = Math.ceil(totalOutlets * pctWire8);
        const qtyNip = Math.ceil(totalOutlets * 0.8); // Assume 80% of boxes need nipples
        const qtyCover = Math.ceil(totalOutlets); // One cover per box
        
        // Calculate material costs with wastage
        const materialCostJunc = qtyJunc * costJunc * (1 + wastage);
        const materialCostUtil = qtyUtil * costUtil * (1 + wastage);
        const materialCostSq = qtySq * costSq * (1 + wastage);
        const materialCostPull = qtyPull * costPull * (1 + wastage);
        const materialCostGutter = qtyGutter * costGutter * (1 + wastage);
        const materialCostNip = qtyNip * costNip * (1 + wastage);
        const materialCostWire4 = qtyWire4 * costWire4 * (1 + wastage);
        const materialCostWire6 = qtyWire6 * costWire6 * (1 + wastage);
        const materialCostWire8 = qtyWire8 * costWire8 * (1 + wastage);
        const materialCostCover = qtyCover * costCover * (1 + wastage);
        
        // Calculate total material cost
        totalMaterialCost = materialCostJunc + materialCostUtil + materialCostSq + materialCostPull + 
                           materialCostGutter + materialCostNip + materialCostWire4 + materialCostWire6 + 
                           materialCostWire8 + materialCostCover;
        
        // Calculate labor cost
        const totalLaborHours = totalOutlets / (productivity * crewSize);
        totalLaborCost = totalLaborHours * laborRate * crewSize;
        
        // Calculate DIRECT COST (Material + Labor)
        const directCost = totalMaterialCost + totalLaborCost;
        
        // Calculate INDIRECT COSTS (all based on direct cost)
        const equipmentCost = directCost * equipmentRate;
        const transportationCost = directCost * transportationRate;
        const tempFacilitiesCost = directCost * tempFacilitiesRate;
        const powerConsumptionCost = directCost * powerConsumptionRate;
        const waterConsumptionCost = directCost * waterConsumptionRate;
        const permitsTaxesCost = directCost * permitsTaxesRate;
        const safetyServicesCost = directCost * safetyServicesRate;
        const bondsInsurancesCost = directCost * bondsInsurancesRate;
        const asBuiltPlansCost = directCost * asBuiltPlansRate;
        const deliveryHaulingCost = directCost * deliveryHaulingRate;
        const contingencyCost = directCost * contingencyRate;
        const overheadCost = directCost * overheadRate;
        
        // Calculate total indirect cost
        const indirectCost = equipmentCost + transportationCost + tempFacilitiesCost + 
                           powerConsumptionCost + waterConsumptionCost + permitsTaxesCost + 
                           safetyServicesCost + bondsInsurancesCost + asBuiltPlansCost + 
                           deliveryHaulingCost + contingencyCost + overheadCost;
        
        // Calculate GRAND TOTAL (Direct + Indirect)
        const grandTotal = directCost + indirectCost;
        
        // Calculate PROFIT MARGIN (applied on Grand Total)
        const profitCost = grandTotal * profitMarginRate;
        
        // Calculate PROJECTED BUDGET (Direct + Indirect + Profit)
        const projectedBudget = grandTotal + profitCost;
        
        // Calculate cost per box
        const costPerBox = projectedBudget / totalOutlets;
        
        // Get currency symbol
        const currencySymbol = getCurrencySymbol();
        
        // Update Bill of Quantities table
        updateBOQTable(circuitResults, totalOutlets, {
            qtyJunc, qtyUtil, qtySq, qtyPull, qtyGutter, qtyNip, qtyWire4, qtyWire6, qtyWire8, qtyCover,
            costJunc, costUtil, costSq, costPull, costGutter, costNip, costWire4, costWire6, costWire8, costCover,
            productivity, laborRate, wastage, materialCostJunc, materialCostUtil, materialCostSq,
            materialCostPull, materialCostGutter, materialCostNip, materialCostWire4, materialCostWire6,
            materialCostWire8, materialCostCover
        }, worstCaseCircuit, currencySymbol);
        
        // Update Cost Breakdown with NEW STRUCTURE
        document.getElementById('materialCostDisplay').textContent = formatCurrency(totalMaterialCost, currencySymbol);
        document.getElementById('laborCostDisplay').textContent = formatCurrency(totalLaborCost, currencySymbol);
        document.getElementById('totalDirectCostDisplay').textContent = formatCurrency(directCost, currencySymbol);
        
        // Update Indirect Costs
        document.getElementById('equipmentCostDisplay').textContent = formatCurrency(equipmentCost, currencySymbol);
        document.getElementById('transportationCostDisplay').textContent = formatCurrency(transportationCost, currencySymbol);
        document.getElementById('tempFacilitiesCostDisplay').textContent = formatCurrency(tempFacilitiesCost, currencySymbol);
        document.getElementById('powerConsumptionCostDisplay').textContent = formatCurrency(powerConsumptionCost, currencySymbol);
        document.getElementById('waterConsumptionCostDisplay').textContent = formatCurrency(waterConsumptionCost, currencySymbol);
        document.getElementById('permitsTaxesCostDisplay').textContent = formatCurrency(permitsTaxesCost, currencySymbol);
        document.getElementById('safetyServicesCostDisplay').textContent = formatCurrency(safetyServicesCost, currencySymbol);
        document.getElementById('bondsInsurancesCostDisplay').textContent = formatCurrency(bondsInsurancesCost, currencySymbol);
        document.getElementById('asBuiltPlansCostDisplay').textContent = formatCurrency(asBuiltPlansCost, currencySymbol);
        document.getElementById('deliveryHaulingCostDisplay').textContent = formatCurrency(deliveryHaulingCost, currencySymbol);
        document.getElementById('contingencyCostDisplay').textContent = formatCurrency(contingencyCost, currencySymbol);
        document.getElementById('overheadCostDisplay').textContent = formatCurrency(overheadCost, currencySymbol);
        document.getElementById('totalIndirectCostDisplay').textContent = formatCurrency(indirectCost, currencySymbol);
        
        // Update Grand Total
        document.getElementById('grandTotalDisplay').textContent = formatCurrency(grandTotal, currencySymbol);
        
        // Update Profit Margin
        document.getElementById('profitCostDisplay').textContent = formatCurrency(profitCost, currencySymbol);
        
        // Update Projected Budget
        document.getElementById('projectedBudgetDisplay').textContent = formatCurrency(projectedBudget, currencySymbol);
        
        // Update project summary
        document.getElementById('totalBoxes').value = Math.round(totalOutlets) + ' boxes';
        document.getElementById('totalLaborHours').value = totalLaborHours.toFixed(1) + ' hours';
        document.getElementById('projectDuration').value = (totalLaborHours / workHours).toFixed(1) + ' days';
        document.getElementById('costPerBox').value = formatCurrency(costPerBox, currencySymbol) + ' per box';
        
        // Update procurement table
        updateProcurementTable({
            qtyJunc, qtyUtil, qtySq, qtyPull, qtyGutter, qtyNip, qtyWire4, qtyWire6, qtyWire8, qtyCover,
            materialCostJunc, materialCostUtil, materialCostSq, materialCostPull, materialCostGutter,
            materialCostNip, materialCostWire4, materialCostWire6, materialCostWire8, materialCostCover,
            totalMaterialCost
        }, worstCaseCircuit, currencySymbol);
        
        // Update circuit results summary
        updateCircuitResultsSummary(circuitResults, totalOutlets);
        
        // Update NEC compliance summary
        checkNECCompliance(necAdjustments, circuitResults);
        
        // Update currency units
        updateCurrencyDisplays();

        // Store project data for export
        projectData = {
            projectName: document.getElementById('projectName').value,
            bidNumber: document.getElementById('bidNumber').value,
            clientName: document.getElementById('clientName').value,
            projectLocation: document.getElementById('projectLocation').value,
            preparedBy: document.getElementById('preparedBy').value,
            projectDate: document.getElementById('projectDate').value,
            currency: document.getElementById('currency').value,
            totals: {
                totalMaterialCost,
                totalLaborCost,
                directCost,
                indirectCost,
                grandTotal,
                profitCost,
                projectedBudget,
                costPerBox,
                // Individual indirect costs
                equipmentCost,
                transportationCost,
                tempFacilitiesCost,
                powerConsumptionCost,
                waterConsumptionCost,
                permitsTaxesCost,
                safetyServicesCost,
                bondsInsurancesCost,
                asBuiltPlansCost,
                deliveryHaulingCost,
                contingencyCost,
                overheadCost
            },
            quantities: {
                totalOutlets,
                qtyJunc,
                qtyUtil,
                qtySq,
                qtyPull,
                qtyGutter,
                qtyWire4,
                qtyWire6,
                qtyWire8,
                qtyNip,
                qtyCover
            },
            labor: {
                totalLaborHours,
                productivity,
                crewSize,
                laborRate,
                workHours
            },
            rates: {
                equipmentRate: equipmentRate * 100,
                transportationRate: transportationRate * 100,
                tempFacilitiesRate: tempFacilitiesRate * 100,
                powerConsumptionRate: powerConsumptionRate * 100,
                waterConsumptionRate: waterConsumptionRate * 100,
                permitsTaxesRate: permitsTaxesRate * 100,
                safetyServicesRate: safetyServicesRate * 100,
                bondsInsurancesRate: bondsInsurancesRate * 100,
                asBuiltPlansRate: asBuiltPlansRate * 100,
                deliveryHaulingRate: deliveryHaulingRate * 100,
                contingencyRate: contingencyRate * 100,
                overheadRate: overheadRate * 100,
                profitMarginRate: profitMarginRate * 100,
                wastage: wastage * 100
            },
            circuits: circuitResults,
            circuitNecResults,
            necAdjustments
        };

        console.log('Calculation completed successfully');
    }
    
    // Circuit validation
    function validateCircuits() {
        const circuits = document.querySelectorAll('.circuit-item');
        if (circuits.length === 0) {
            alert('Please add at least one circuit type in the Circuit Types tab.');
            return false;
        }
        
        return updateCircuitTotals(); // This also validates percentage totals
    }
    
    // Update circuit summary in General tab
    function updateCircuitSummary(circuitResults, totalOutlets) {
        const summaryElement = document.getElementById('circuitSummaryContent');
        let summaryHTML = '<div class="circuit-totals">';
        
        circuitResults.forEach(circuit => {
            summaryHTML += `
                <div class="circuit-total-item">
                    <div style="font-weight: bold;">${circuit.description}</div>
                    <div>${circuit.wireSize} AWG</div>
                    <div>${(circuit.percentage * 100).toFixed(0)}% (${circuit.circuitBoxes} boxes)</div>
                </div>
            `;
        });
        
        summaryHTML += `
            <div class="circuit-total-item" style="background: #e8f5e8;">
                <div style="font-weight: bold;">TOTAL</div>
                <div>Multi-Wire</div>
                <div>100% (${Math.round(totalOutlets)} boxes)</div>
            </div>
        </div>
        `;
        
        summaryElement.innerHTML = summaryHTML;
    }
    
    // Update circuit NEC results in Circuits tab
    function updateCircuitNecResults(circuitResults) {
        const resultsElement = document.getElementById('circuitNecResults');
        let resultsHTML = '';
        
        circuitResults.forEach(circuit => {
            const nec = circuit.necResult;
            const statusClass = nec.isCompliant ? 'nec-pass' : 'nec-fail';
            const statusText = nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
            
            resultsHTML += `
                <div class="circuit-item">
                    <div class="circuit-header">
                        <span class="circuit-title">${circuit.description}</span>
                        <span class="circuit-wire-size">${circuit.wireSize} AWG</span>
                    </div>
                    <div class="nec-result ${statusClass}">
                        ${statusText}: ${formatNumber(nec.volumeWithSafety, 2)} cu. in. required
                        ${nec.smallestSuitableBox ? ` - Minimum: ${nec.smallestSuitableBox}` : ' - Custom box needed'}
                    </div>
                    <div class="nec-details">
                        <p><strong>Calculation Details:</strong></p>
                        <ul>
                            <li>Conductors: ${circuit.conductors} current + 2 pigtails = ${(circuit.conductors + 2)} × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
                            <li>Devices: ${circuit.devices} × 2 × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
                            <li>Clamps: ${circuit.clamps} × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
                            <li>Ground: 1 × ${formatNumber(nec.volPerConductor, 2)} cu. in.</li>
                        </ul>
                    </div>
                </div>
            `;
        });
        
        resultsElement.innerHTML = resultsHTML;
    }
    
    // Update circuit results summary in output
    function updateCircuitResultsSummary(circuitResults, totalOutlets) {
        const summaryElement = document.getElementById('circuitResultsSummary');
        let summaryHTML = '<div class="circuit-totals">';
        
        circuitResults.forEach(circuit => {
            const nec = circuit.necResult;
            const statusText = nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
            const statusColor = nec.isCompliant ? '#2e7d32' : '#c62828';
            
            summaryHTML += `
                <div class="circuit-total-item">
                    <div style="font-weight: bold;">${circuit.description}</div>
                    <div>${circuit.wireSize} AWG</div>
                    <div>${circuit.circuitBoxes} boxes</div>
                    <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                </div>
            `;
        });
        
        summaryHTML += `
            <div class="circuit-total-item" style="background: #e8f5e8;">
                <div style="font-weight: bold;">PROJECT TOTAL</div>
                <div>Multi-Wire</div>
                <div>${Math.round(totalOutlets)} boxes</div>
                <div style="font-weight: bold;">OPTIMIZED</div>
            </div>
        </div>
        `;
        
        summaryElement.innerHTML = summaryHTML;
    }
    
    // Enhanced NEC compliance check for multi-wire
    function checkNECCompliance(necAdjustments = [], circuitResults = []) {
        const summaryElement = document.getElementById('necComplianceSummary');
        const warningElement = document.getElementById('necComplianceWarning');
        
        let summaryHTML = '<p><strong>Multi-Wire NEC 314.16 Compliance Summary:</strong></p>';
        
        let hasComplianceIssue = false;
        let allCompliant = true;
        
        circuitResults.forEach(circuit => {
            const nec = circuit.necResult;
            if (!nec.isCompliant) {
                allCompliant = false;
                hasComplianceIssue = true;
            }
            
            summaryHTML += `
                <p><strong>${circuit.description} (${circuit.wireSize} AWG):</strong></p>
                <ul>
                    <li>Required Volume: ${formatNumber(nec.volumeWithSafety, 2)} cu. in.</li>
                    <li>Status: <span style="color: ${nec.isCompliant ? '#2e7d32' : '#c62828'}">${nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT'}</span></li>
                    <li>Minimum Box: ${nec.smallestSuitableBox || 'Custom box required'}</li>
                </ul>
            `;
        });
        
        if (necAdjustments.length > 0) {
            summaryHTML += '<p><strong>Automatic Adjustments Applied:</strong></p><ul>';
            necAdjustments.forEach(adjustment => {
                summaryHTML += `<li>${adjustment}</li>`;
            });
            summaryHTML += '</ul>';
        }
        
        summaryHTML += `<p><strong>Overall Project Status:</strong> <span style="color: ${allCompliant ? '#2e7d32' : '#c62828'}">${allCompliant ? 'FULLY COMPLIANT' : 'REVIEW REQUIRED'}</span></p>`;
        
        summaryElement.innerHTML = summaryHTML;
        
        if (hasComplianceIssue) {
            warningElement.classList.remove('hidden');
        } else {
            warningElement.classList.add('hidden');
        }
    }
    
    // Input validation function - UPDATED for new indirect cost fields
    function validateInputs() {
        let isValid = true;
        
        // Project name validation
        const projectName = document.getElementById('projectName').value.trim();
        if (!projectName) {
            document.getElementById('projectNameError').style.display = 'block';
            document.getElementById('projectName').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('projectNameError').style.display = 'none';
            document.getElementById('projectName').classList.remove('input-error');
        }
        
        // Wall area validation
        const wallArea = parseFloat(document.getElementById('wallArea').value);
        if (isNaN(wallArea) || wallArea <= 0) {
            document.getElementById('wallAreaError').style.display = 'block';
            document.getElementById('wallArea').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('wallAreaError').style.display = 'none';
            document.getElementById('wallArea').classList.remove('input-error');
        }
        
        // Density validation
        const density = parseFloat(document.getElementById('density').value);
        if (isNaN(density) || density < 0) {
            document.getElementById('densityError').style.display = 'block';
            document.getElementById('density').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('densityError').style.display = 'none';
            document.getElementById('density').classList.remove('input-error');
        }
        
        // Wastage validation
        const wastage = parseFloat(document.getElementById('wastage').value);
        if (isNaN(wastage) || wastage < 0 || wastage > 30) {
            document.getElementById('wastageError').style.display = 'block';
            document.getElementById('wastage').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('wastageError').style.display = 'none';
            document.getElementById('wastage').classList.remove('input-error');
        }
        
        // Overhead rate validation
        const overheadRate = parseFloat(document.getElementById('overheadRate').value);
        if (isNaN(overheadRate) || overheadRate < 0 || overheadRate > 100) {
            document.getElementById('overheadRateError').style.display = 'block';
            document.getElementById('overheadRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('overheadRateError').style.display = 'none';
            document.getElementById('overheadRate').classList.remove('input-error');
        }
        
        // Profit margin validation
        const profitMargin = parseFloat(document.getElementById('profitMarginRate').value);
        if (isNaN(profitMargin) || profitMargin < 0 || profitMargin > 100) {
            document.getElementById('profitMarginError').style.display = 'block';
            document.getElementById('profitMarginRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('profitMarginError').style.display = 'none';
            document.getElementById('profitMarginRate').classList.remove('input-error');
        }
        
        // Equipment cost validation
        const equipmentCost = parseFloat(document.getElementById('equipmentCost').value);
        if (isNaN(equipmentCost) || equipmentCost < 0 || equipmentCost > 50) {
            document.getElementById('equipmentCostError').style.display = 'block';
            document.getElementById('equipmentCost').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('equipmentCostError').style.display = 'none';
            document.getElementById('equipmentCost').classList.remove('input-error');
        }
        
        // Transportation cost validation
        const transportationCost = parseFloat(document.getElementById('transportationCost').value);
        if (isNaN(transportationCost) || transportationCost < 0 || transportationCost > 50) {
            document.getElementById('transportationCostError').style.display = 'block';
            document.getElementById('transportationCost').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('transportationCostError').style.display = 'none';
            document.getElementById('transportationCost').classList.remove('input-error');
        }
        
        // New indirect cost validations
        const tempFacilitiesRate = parseFloat(document.getElementById('tempFacilitiesRate').value);
        if (isNaN(tempFacilitiesRate) || tempFacilitiesRate < 0 || tempFacilitiesRate > 20) {
            document.getElementById('tempFacilitiesRateError').style.display = 'block';
            document.getElementById('tempFacilitiesRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('tempFacilitiesRateError').style.display = 'none';
            document.getElementById('tempFacilitiesRate').classList.remove('input-error');
        }
        
        const powerConsumptionRate = parseFloat(document.getElementById('powerConsumptionRate').value);
        if (isNaN(powerConsumptionRate) || powerConsumptionRate < 0 || powerConsumptionRate > 10) {
            document.getElementById('powerConsumptionRateError').style.display = 'block';
            document.getElementById('powerConsumptionRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('powerConsumptionRateError').style.display = 'none';
            document.getElementById('powerConsumptionRate').classList.remove('input-error');
        }
        
        const waterConsumptionRate = parseFloat(document.getElementById('waterConsumptionRate').value);
        if (isNaN(waterConsumptionRate) || waterConsumptionRate < 0 || waterConsumptionRate > 5) {
            document.getElementById('waterConsumptionRateError').style.display = 'block';
            document.getElementById('waterConsumptionRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('waterConsumptionRateError').style.display = 'none';
            document.getElementById('waterConsumptionRate').classList.remove('input-error');
        }
        
        const permitsTaxesRate = parseFloat(document.getElementById('permitsTaxesRate').value);
        if (isNaN(permitsTaxesRate) || permitsTaxesRate < 0 || permitsTaxesRate > 15) {
            document.getElementById('permitsTaxesRateError').style.display = 'block';
            document.getElementById('permitsTaxesRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('permitsTaxesRateError').style.display = 'none';
            document.getElementById('permitsTaxesRate').classList.remove('input-error');
        }
        
        const safetyServicesRate = parseFloat(document.getElementById('safetyServicesRate').value);
        if (isNaN(safetyServicesRate) || safetyServicesRate < 0 || safetyServicesRate > 10) {
            document.getElementById('safetyServicesRateError').style.display = 'block';
            document.getElementById('safetyServicesRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('safetyServicesRateError').style.display = 'none';
            document.getElementById('safetyServicesRate').classList.remove('input-error');
        }
        
        const bondsInsurancesRate = parseFloat(document.getElementById('bondsInsurancesRate').value);
        if (isNaN(bondsInsurancesRate) || bondsInsurancesRate < 0 || bondsInsurancesRate > 10) {
            document.getElementById('bondsInsurancesRateError').style.display = 'block';
            document.getElementById('bondsInsurancesRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('bondsInsurancesRateError').style.display = 'none';
            document.getElementById('bondsInsurancesRate').classList.remove('input-error');
        }
        
        const asBuiltPlansRate = parseFloat(document.getElementById('asBuiltPlansRate').value);
        if (isNaN(asBuiltPlansRate) || asBuiltPlansRate < 0 || asBuiltPlansRate > 5) {
            document.getElementById('asBuiltPlansRateError').style.display = 'block';
            document.getElementById('asBuiltPlansRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('asBuiltPlansRateError').style.display = 'none';
            document.getElementById('asBuiltPlansRate').classList.remove('input-error');
        }
        
        const deliveryHaulingRate = parseFloat(document.getElementById('deliveryHaulingRate').value);
        if (isNaN(deliveryHaulingRate) || deliveryHaulingRate < 0 || deliveryHaulingRate > 10) {
            document.getElementById('deliveryHaulingRateError').style.display = 'block';
            document.getElementById('deliveryHaulingRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('deliveryHaulingRateError').style.display = 'none';
            document.getElementById('deliveryHaulingRate').classList.remove('input-error');
        }
        
        const contingencyRate = parseFloat(document.getElementById('contingencyRate').value);
        if (isNaN(contingencyRate) || contingencyRate < 0 || contingencyRate > 20) {
            document.getElementById('contingencyRateError').style.display = 'block';
            document.getElementById('contingencyRate').classList.add('input-error');
            isValid = false;
        } else {
            document.getElementById('contingencyRateError').style.display = 'none';
            document.getElementById('contingencyRate').classList.remove('input-error');
        }
        
        // Distribution validation
        if (!validateDistribution()) {
            isValid = false;
        }
        
        return isValid;
    }
    
    // Enhanced PDF Export Functions for Multi-Wire - UPDATED for new cost structure
    function getSelectedCurrency() {
        const el = document.getElementById('currency');
        return el ? el.value : 'PHP';
    }

    function getPdfCurrencyPrefix(code) {
        switch (code) {
            case 'PHP': return 'PHP ';
            case 'USD': return '$';
            case 'EUR': return '€';
            case 'JPY': return '¥';
            default: return code + ' ';
        }
    }

    function formatNumberForPDF(num, decimals = 2) {
        if (typeof num !== 'number' || isNaN(num)) return '0';
        return num.toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatCurrencyForPDF(n) {
        if (typeof n !== 'number' || isNaN(n)) return '0.00';
        const prefix = getPdfCurrencyPrefix(getSelectedCurrency());
        return prefix + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function exportToPDF() {
        if (!projectData.totals) {
            alert('No results to export. Please calculate an estimate first.');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // Reserved areas
            const HEADER_H = 65;
            const FOOTER_H = 30;
            const CONTENT_MARGIN_L = 35;
            const CONTENT_MARGIN_R = 35;

            // Common styles
            const BRAND = { r: 44, g: 62, b: 80 }; // #2c3e50
            doc.setFont('helvetica', 'normal');

            // Header/Footer drawer (runs on every page)
            function drawHeaderFooter(data) {
                // Header bar
                doc.setFillColor(240, 240, 240);
                doc.rect(0, 0, pageWidth, HEADER_H, 'F');

                // Title
                doc.setFont('helvetica', 'bold'); 
                doc.setFontSize(13);
                doc.setTextColor(BRAND.r, BRAND.g, BRAND.b);
                doc.text('PROFESSIONAL ELECTRICAL BOXES & COVERS ESTIMATE', pageWidth / 2, 24, { align: 'center' });

                // Meta
                doc.setFont('helvetica', 'normal'); 
                doc.setFontSize(8); 
                doc.setTextColor(0);

                const projectName = document.getElementById('projectName').value || 'Unnamed Project';
                const clientName = document.getElementById('clientName').value || 'Not specified';
                const preparedBy = document.getElementById('preparedBy').value || 'Not specified';
                const bidNumber = document.getElementById('bidNumber').value || 'Not specified';
                const dateStr = document.getElementById('projectDate').value || '';

                doc.text(`Project: ${projectName}`, CONTENT_MARGIN_L, 40);
                doc.text(`Client: ${clientName}`, CONTENT_MARGIN_L, 52);
                doc.text(`Bid Number: ${bidNumber}`, pageWidth - CONTENT_MARGIN_R, 40, { align: 'right' });
                doc.text(`Prepared By: ${preparedBy}`, pageWidth - CONTENT_MARGIN_R, 52, { align: 'right' });

                // Header rule
                doc.setDrawColor(BRAND.r, BRAND.g, BRAND.b); 
                doc.setLineWidth(0.5);
                doc.line(CONTENT_MARGIN_L, HEADER_H - 6, pageWidth - CONTENT_MARGIN_R, HEADER_H - 6);

                // Footer
                const pageNumber = doc.internal.getNumberOfPages();
                doc.setFontSize(8); 
                doc.setTextColor(100);
                doc.text(`Page ${pageNumber}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, CONTENT_MARGIN_L, pageHeight - 12);
                doc.text(`Multi-Wire NEC 2023 Compliant`, pageWidth - CONTENT_MARGIN_R, pageHeight - 12, { align: 'right' });
            }

            // Common AutoTable options - Full width tables
            const TABLE_OPTS = {
                margin: { 
                    left: CONTENT_MARGIN_L, 
                    right: CONTENT_MARGIN_R, 
                    top: HEADER_H + 6, 
                    bottom: FOOTER_H + 6 
                },
                styles: {
                    font: 'helvetica',
                    fontSize: 7,
                    cellPadding: 3,
                    lineWidth: 0.25,
                    lineColor: 100,
                    overflow: 'linebreak',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [BRAND.r, BRAND.g, BRAND.b],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 7
                },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                didDrawPage: drawHeaderFooter,
                tableWidth: 'auto' // This makes tables stretch to full width
            };

            // Section helper
            function sectionTitle(text) {
                doc.setFont('helvetica', 'bold'); 
                doc.setFontSize(10);
                doc.setTextColor(BRAND.r, BRAND.g, BRAND.b);
                const y = (doc.lastAutoTable?.finalY || (HEADER_H + 12)) + 12;
                doc.text(text, CONTENT_MARGIN_L, y);
                return y + 4;
            }

            // Calculate available width for tables
            const availableWidth = pageWidth - CONTENT_MARGIN_L - CONTENT_MARGIN_R;

            // ==== Circuit Summary ====
            let startY = sectionTitle('CIRCUIT SUMMARY');
            
            const circuitHead = [
                ['Circuit Type', 'Wire Size', 'Percentage', 'Boxes', 'NEC Status']
            ];
            
            const circuitBody = [];
            let totalBoxes = 0;

            if (projectData.circuits && projectData.circuits.length > 0) {
                projectData.circuits.forEach(circuit => {
                    const nec = circuit.necResult;
                    const status = nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT';
                    circuitBody.push([
                        circuit.description,
                        circuit.wireSize + ' AWG',
                        (circuit.percentage * 100).toFixed(0) + '%',
                        circuit.circuitBoxes.toString(),
                        status
                    ]);
                    totalBoxes += circuit.circuitBoxes;
                });

                // Add total row
                circuitBody.push([
                    'TOTAL',
                    'Multi-Wire',
                    '100%',
                    totalBoxes.toString(),
                    'OPTIMIZED'
                ]);

                // Column widths for circuit summary
                const circuitColumnStyles = {
                    0: { cellWidth: availableWidth * 0.35 }, // Circuit Type
                    1: { cellWidth: availableWidth * 0.15 }, // Wire Size
                    2: { cellWidth: availableWidth * 0.15 }, // Percentage
                    3: { cellWidth: availableWidth * 0.15 }, // Boxes
                    4: { cellWidth: availableWidth * 0.20 }  // NEC Status
                };

                doc.autoTable({
                    ...TABLE_OPTS,
                    startY: startY,
                    head: circuitHead,
                    body: circuitBody,
                    columnStyles: circuitColumnStyles,
                    didParseCell: function(data) {
                        // Style the total row
                        if (data.section === 'body' && data.row.index === circuitBody.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [220, 240, 220];
                        }
                        // Color code NEC status
                        if (data.column.index === 4) {
                            if (data.cell.raw === 'COMPLIANT') {
                                data.cell.styles.textColor = [46, 125, 50];
                            } else if (data.cell.raw === 'NON-COMPLIANT') {
                                data.cell.styles.textColor = [198, 40, 40];
                            } else if (data.cell.raw === 'OPTIMIZED') {
                                data.cell.styles.textColor = [30, 136, 229];
                            }
                        }
                    }
                });
            }

            // ==== Bill of Quantity ====
            startY = sectionTitle('BILL OF QUANTITY');
            
            const boqHead = [
                ['Item', 'Description', 'Qty', 'Unit', 'Unit Cost', 'Material Cost', 'Labor Cost', 'Total']
            ];
            
            const boqBody = [];
            let totalMaterialCost = 0;
            let totalLaborCost = 0;

            // Get data from the current table and calculate totals
            const boqTable = document.getElementById('billOfQuantity');
            const rows = boqTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    const rowData = [
                        cells[0].textContent.trim(),
                        cells[1].textContent.trim(),
                        cells[2].textContent.trim(),
                        cells[3].textContent.trim(),
                        cells[4].textContent.trim(),
                        cells[5].textContent.trim(),
                        cells[6].textContent.trim(),
                        cells[7].textContent.trim()
                    ];
                    boqBody.push(rowData);
                    
                    // Extract numeric values for totals
                    const materialCost = parseFloat(cells[5].textContent.replace(/[^0-9.-]+/g,"")) || 0;
                    const laborCost = parseFloat(cells[6].textContent.replace(/[^0-9.-]+/g,"")) || 0;
                    totalMaterialCost += materialCost;
                    totalLaborCost += laborCost;
                }
            });

            // Add total direct cost row
            const totalDirectCost = totalMaterialCost + totalLaborCost;
            boqBody.push([
                'TOTAL DIRECT COST',
                '',
                '',
                '',
                '',
                formatCurrencyForPDF(totalMaterialCost),
                formatCurrencyForPDF(totalLaborCost),
                formatCurrencyForPDF(totalDirectCost)
            ]);

            // Column widths for full width table
            const boqColumnStyles = {
                0: { cellWidth: availableWidth * 0.10 }, // Item
                1: { cellWidth: availableWidth * 0.22 }, // Description
                2: { cellWidth: availableWidth * 0.07 }, // Qty
                3: { cellWidth: availableWidth * 0.07 }, // Unit
                4: { cellWidth: availableWidth * 0.10 }, // Unit Cost
                5: { cellWidth: availableWidth * 0.13 }, // Material Cost
                6: { cellWidth: availableWidth * 0.13 }, // Labor Cost
                7: { cellWidth: availableWidth * 0.18 }  // Total
            };

            doc.autoTable({
                ...TABLE_OPTS,
                startY: startY,
                head: boqHead,
                body: boqBody,
                columnStyles: boqColumnStyles,
                didParseCell: function(data) {
                    // Bold and style the total direct cost row
                    if (data.section === 'body' && data.row.index === boqBody.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [240, 240, 240];
                        data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                    }
                    // Right align numeric columns
                    if (data.column.index >= 4) {
                        data.cell.styles.halign = 'right';
                    }
                    if (data.column.index === 2) { // Qty column
                        data.cell.styles.halign = 'right';
                    }
                }
            });

            // ==== COMPLETE COST BREAKDOWN (NEW STRUCTURE) ====
            startY = sectionTitle('COMPLETE COST BREAKDOWN');
            
            const costData = [
                ['DIRECT COSTS', formatCurrencyForPDF(projectData.totals.directCost)],
                ['', ''],
                ['  Material Cost', formatCurrencyForPDF(projectData.totals.totalMaterialCost)],
                ['  Labor Cost', formatCurrencyForPDF(projectData.totals.totalLaborCost)],
                ['', ''],
                ['INDIRECT COSTS', formatCurrencyForPDF(projectData.totals.indirectCost)],
                ['', ''],
                ['  Equipment Cost', formatCurrencyForPDF(projectData.totals.equipmentCost) + ` (${projectData.rates.equipmentRate}%)`],
                ['  Transportation Cost', formatCurrencyForPDF(projectData.totals.transportationCost) + ` (${projectData.rates.transportationRate}%)`],
                ['  Temporary Facilities', formatCurrencyForPDF(projectData.totals.tempFacilitiesCost) + ` (${projectData.rates.tempFacilitiesRate}%)`],
                ['  Power Consumption', formatCurrencyForPDF(projectData.totals.powerConsumptionCost) + ` (${projectData.rates.powerConsumptionRate}%)`],
                ['  Water Consumption', formatCurrencyForPDF(projectData.totals.waterConsumptionCost) + ` (${projectData.rates.waterConsumptionRate}%)`],
                ['  Permits & Taxes', formatCurrencyForPDF(projectData.totals.permitsTaxesCost) + ` (${projectData.rates.permitsTaxesRate}%)`],
                ['  Safety/Sanitation/Security', formatCurrencyForPDF(projectData.totals.safetyServicesCost) + ` (${projectData.rates.safetyServicesRate}%)`],
                ['  Bonds & Insurances', formatCurrencyForPDF(projectData.totals.bondsInsurancesCost) + ` (${projectData.rates.bondsInsurancesRate}%)`],
                ['  As-Built Plans', formatCurrencyForPDF(projectData.totals.asBuiltPlansCost) + ` (${projectData.rates.asBuiltPlansRate}%)`],
                ['  Delivery & Hauling Charges', formatCurrencyForPDF(projectData.totals.deliveryHaulingCost) + ` (${projectData.rates.deliveryHaulingRate}%)`],
                ['  Contingency Cost', formatCurrencyForPDF(projectData.totals.contingencyCost) + ` (${projectData.rates.contingencyRate}%)`],
                ['  Overhead Rate', formatCurrencyForPDF(projectData.totals.overheadCost) + ` (${projectData.rates.overheadRate}%)`],
                ['', ''],
                ['GRAND TOTAL (Direct + Indirect)', formatCurrencyForPDF(projectData.totals.grandTotal)],
                ['', ''],
                ['PROFIT MARGIN', formatCurrencyForPDF(projectData.totals.profitCost) + ` (${projectData.rates.profitMarginRate}%)`],
                ['', ''],
                ['PROJECTED BUDGET', formatCurrencyForPDF(projectData.totals.projectedBudget)]
            ];

            // Column widths for cost breakdown
            const costColumnStyles = {
                0: { cellWidth: availableWidth * 0.6 },
                1: { cellWidth: availableWidth * 0.4, halign: 'right' }
            };

            doc.autoTable({
                ...TABLE_OPTS,
                startY: startY,
                head: [['Category', 'Amount']],
                body: costData,
                columnStyles: costColumnStyles,
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        // Style section headers
                        if (data.cell.raw === 'DIRECT COSTS' || data.cell.raw === 'INDIRECT COSTS' || 
                            data.cell.raw === 'GRAND TOTAL (Direct + Indirect)' || 
                            data.cell.raw === 'PROFIT MARGIN' || data.cell.raw === 'PROJECTED BUDGET') {
                            data.cell.styles.fillColor = [240, 240, 240];
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                        }
                        
                        // Style the projected budget row
                        if (data.cell.raw === 'PROJECTED BUDGET') {
                            data.cell.styles.fillColor = [220, 240, 220];
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                        }
                        
                        // Indent sub-items
                        if (data.cell.raw.startsWith('  ')) {
                            data.cell.styles.fontStyle = 'normal';
                            data.cell.styles.textColor = [100, 100, 100];
                        }
                        
                        // Empty rows for spacing
                        if (data.cell.raw === '') {
                            data.cell.styles.fontSize = 4;
                        }
                    }
                }
            });

            // ==== Project Summary ====
            startY = sectionTitle('PROJECT SUMMARY');
            
            const summaryData = [
                ['Total Boxes', Math.round(projectData.quantities.totalOutlets) + ' boxes'],
                ['Total Labor Hours', formatNumberForPDF(projectData.labor.totalLaborHours, 1) + ' hours'],
                ['Project Duration', formatNumberForPDF(projectData.labor.totalLaborHours / projectData.labor.workHours, 1) + ' days'],
                ['Cost per Box', formatCurrencyForPDF(projectData.totals.costPerBox)],
                ['Crew Size', projectData.labor.crewSize + ' workers'],
                ['Productivity', projectData.labor.productivity + ' boxes/hour/worker'],
                ['Labor Rate', formatCurrencyForPDF(projectData.labor.laborRate) + '/hour'],
                ['Wastage', projectData.rates.wastage + '%']
            ];

            // Column widths for project summary
            const summaryColumnStyles = {
                0: { cellWidth: availableWidth * 0.5 },
                1: { cellWidth: availableWidth * 0.5, halign: 'right' }
            };

            doc.autoTable({
                ...TABLE_OPTS,
                startY: startY,
                head: [['Parameter', 'Value']],
                body: summaryData,
                columnStyles: summaryColumnStyles
            });

            // ==== Multi-Wire NEC Compliance Details ====
            if (projectData.circuits && projectData.circuits.length > 0) {
                startY = sectionTitle('MULTI-WIRE NEC 314.16 COMPLIANCE DETAILS');
                
                // Find the worst-case circuit for overall compliance
                let worstCaseCircuit = null;
                let maxVolumeRequired = 0;
                
                projectData.circuits.forEach(circuit => {
                    if (circuit.necResult.volumeWithSafety > maxVolumeRequired) {
                        maxVolumeRequired = circuit.necResult.volumeWithSafety;
                        worstCaseCircuit = circuit;
                    }
                });

                if (worstCaseCircuit) {
                    const nec = worstCaseCircuit.necResult;
                    const necData = [
                        ['Worst-Case Circuit', worstCaseCircuit.description + ' (' + worstCaseCircuit.wireSize + ' AWG)'],
                        ['Conductor Size', worstCaseCircuit.wireSize + ' AWG'],
                        ['Current Conductors', worstCaseCircuit.conductors],
                        ['Pigtails', nec.pigtails],
                        ['Grounding Conductors', nec.groundingConductors],
                        ['Devices', worstCaseCircuit.devices],
                        ['Cable Clamps', worstCaseCircuit.clamps],
                        ['Volume per Conductor', formatNumberForPDF(nec.volPerConductor, 2) + ' cu. in.'],
                        ['Total Volume Required', formatNumberForPDF(nec.totalVolumeRequired, 2) + ' cu. in.'],
                        ['Safety Factor', nec.safetyFactor + '%'],
                        ['Volume with Safety', formatNumberForPDF(nec.volumeWithSafety, 2) + ' cu. in.'],
                        ['Minimum Required Box', nec.smallestSuitableBox || 'Custom box required'],
                        ['Compliance Status', nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT']
                    ];

                    // Add NEC adjustments if any
                    if (projectData.necAdjustments && projectData.necAdjustments.length > 0) {
                        necData.push(['', '']);
                        necData.push(['NEC-Driven Adjustments:', '']);
                        projectData.necAdjustments.forEach(adjustment => {
                            necData.push(['', adjustment]);
                        });
                    }

                    // Column widths for NEC details
                    const necColumnStyles = {
                        0: { cellWidth: availableWidth * 0.6, fontStyle: 'bold' },
                        1: { cellWidth: availableWidth * 0.4 }
                    };

                    doc.autoTable({
                        ...TABLE_OPTS,
                        startY: startY,
                        head: [['Parameter', 'Value']],
                        body: necData,
                        columnStyles: necColumnStyles,
                        didParseCell: function(data) {
                            if (data.section === 'body') {
                                // Highlight compliance status
                                if (data.cell.raw === 'COMPLIANT') {
                                    data.cell.styles.textColor = [46, 125, 50]; // Green
                                    data.cell.styles.fontStyle = 'bold';
                                } else if (data.cell.raw === 'NON-COMPLIANT') {
                                    data.cell.styles.textColor = [198, 40, 40]; // Red
                                    data.cell.styles.fontStyle = 'bold';
                                }
                                
                                // Style adjustments section
                                if (data.row.raw[0] === 'NEC-Driven Adjustments:') {
                                    data.cell.styles.fontStyle = 'bold';
                                    data.cell.styles.fillColor = [255, 243, 224];
                                } else if (data.row.raw[0] === '' && data.column.index === 1 && data.row.index > 12) {
                                    data.cell.styles.fontStyle = 'italic';
                                }
                            }
                        }
                    });
                }
            }

            // ==== Procurement Summary ====
            startY = sectionTitle('PROCUREMENT SUMMARY');
            
            const procurementData = [];
            const procurementTable = document.getElementById('procurementTable');
            const procurementRows = procurementTable.querySelectorAll('tbody tr');
            
            procurementRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    procurementData.push([
                        cells[0].textContent.trim(),
                        cells[1].textContent.trim(),
                        cells[2].textContent.trim(),
                        cells[3].textContent.trim(),
                        cells[4].textContent.trim()
                    ]);
                }
            });

            // Get total procurement cost
            const totalProcurementRow = procurementTable.querySelector('tfoot tr');
            const totalProcurementCost = totalProcurementRow ? totalProcurementRow.querySelector('td:last-child').textContent : '0.00';

            procurementData.push([
                'TOTAL PROCUREMENT COST',
                '',
                '',
                '',
                totalProcurementCost
            ]);

            // Column widths for procurement summary
            const procurementColumnStyles = {
                0: { cellWidth: availableWidth * 0.25 }, // Item
                1: { cellWidth: availableWidth * 0.12, halign: 'right' }, // Qty Needed
                2: { cellWidth: availableWidth * 0.18 }, // Packaging
                3: { cellWidth: availableWidth * 0.15, halign: 'right' }, // Units to Order
                4: { cellWidth: availableWidth * 0.30, halign: 'right' } // Cost
            };

            doc.autoTable({
                ...TABLE_OPTS,
                startY: startY,
                head: [['Item', 'Qty Needed', 'Packaging', 'Units to Order', 'Cost']],
                body: procurementData,
                columnStyles: procurementColumnStyles,
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        // Style the total row
                        if (data.row.index === procurementData.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [240, 240, 240];
                            data.cell.styles.textColor = [BRAND.r, BRAND.g, BRAND.b];
                        }
                        // Right align numeric columns
                        if (data.column.index === 1 || data.column.index === 3 || data.column.index === 4) {
                            data.cell.styles.halign = 'right';
                        }
                    }
                }
            });

            const fileName = (projectData.projectName || 'estimate').replace(/[^a-z0-9]/gi, '-') + '_multi_wire_electrical_estimate.pdf';
            doc.save(fileName);

        } catch (e) {
            console.error('PDF Generation Error:', e);
            alert('Error generating PDF: ' + e.message);
        }
    }

    // Update the event listener to use the new function
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    
    // Export to Excel - UPDATED for new cost structure
    function exportToExcel() {
        if (!projectData.totals) {
            alert('No results to export. Please calculate an estimate first.');
            return;
        }
        // Create a new workbook
        const wb = XLSX.utils.book_new();
        
        // Prepare data for the Bill of Quantities sheet
        const boqData = [
            ['Item', 'Description', 'Qty', 'Unit', 'Unit Cost', 'Material Cost', 'Labor Cost', 'Total']
        ];
        
        // Get data from the table
        const boqTable = document.getElementById('billOfQuantity');
        const rows = boqTable.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 1) { // Skip empty rows
                const rowData = [];
                cells.forEach(cell => {
                    rowData.push(cell.textContent);
                });
                boqData.push(rowData);
            }
        });
        
        // Add total row
        const totalRow = boqTable.querySelector('tfoot tr');
        const totalCells = totalRow.querySelectorAll('td');
        const totalData = [];
        totalCells.forEach(cell => {
            totalData.push(cell.textContent);
        });
        boqData.push(totalData);
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(boqData);
        
        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Bill of Quantities');
        
        // Create Circuit Summary sheet
        const circuitData = [
            ['Multi-Wire Circuit Summary'],
            ['Circuit Type', 'Wire Size', 'Percentage', 'Boxes', 'NEC Status', 'Required Volume', 'Minimum Box']
        ];
        
        projectData.circuits.forEach(circuit => {
            const nec = circuit.necResult;
            circuitData.push([
                circuit.description,
                circuit.wireSize + ' AWG',
                (circuit.percentage * 100).toFixed(0) + '%',
                circuit.circuitBoxes,
                nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT',
                formatNumberForPDF(nec.volumeWithSafety, 2) + ' cu. in.',
                nec.smallestSuitableBox || 'Custom box required'
            ]);
        });
        
        // Add totals
        circuitData.push([
            'TOTAL',
            'Multi-Wire',
            '100%',
            Math.round(projectData.quantities.totalOutlets),
            'OPTIMIZED',
            '',
            ''
        ]);
        
        const circuitWs = XLSX.utils.aoa_to_sheet(circuitData);
        XLSX.utils.book_append_sheet(wb, circuitWs, 'Circuit Summary');
        
        // Create Complete Cost Breakdown sheet (NEW STRUCTURE)
        const costData = [
            ['COMPLETE COST BREAKDOWN'],
            ['Category', 'Amount', 'Percentage'],
            ['DIRECT COSTS', formatCurrencyForPDF(projectData.totals.directCost), ''],
            ['', '', ''],
            ['  Material Cost', formatCurrencyForPDF(projectData.totals.totalMaterialCost), ''],
            ['  Labor Cost', formatCurrencyForPDF(projectData.totals.totalLaborCost), ''],
            ['', '', ''],
            ['INDIRECT COSTS', formatCurrencyForPDF(projectData.totals.indirectCost), ''],
            ['', '', ''],
            ['  Equipment Cost', formatCurrencyForPDF(projectData.totals.equipmentCost), projectData.rates.equipmentRate + '%'],
            ['  Transportation Cost', formatCurrencyForPDF(projectData.totals.transportationCost), projectData.rates.transportationRate + '%'],
            ['  Temporary Facilities', formatCurrencyForPDF(projectData.totals.tempFacilitiesCost), projectData.rates.tempFacilitiesRate + '%'],
            ['  Power Consumption', formatCurrencyForPDF(projectData.totals.powerConsumptionCost), projectData.rates.powerConsumptionRate + '%'],
            ['  Water Consumption', formatCurrencyForPDF(projectData.totals.waterConsumptionCost), projectData.rates.waterConsumptionRate + '%'],
            ['  Permits & Taxes', formatCurrencyForPDF(projectData.totals.permitsTaxesCost), projectData.rates.permitsTaxesRate + '%'],
            ['  Safety/Sanitation/Security', formatCurrencyForPDF(projectData.totals.safetyServicesCost), projectData.rates.safetyServicesRate + '%'],
            ['  Bonds & Insurances', formatCurrencyForPDF(projectData.totals.bondsInsurancesCost), projectData.rates.bondsInsurancesRate + '%'],
            ['  As-Built Plans', formatCurrencyForPDF(projectData.totals.asBuiltPlansCost), projectData.rates.asBuiltPlansRate + '%'],
            ['  Delivery & Hauling Charges', formatCurrencyForPDF(projectData.totals.deliveryHaulingCost), projectData.rates.deliveryHaulingRate + '%'],
            ['  Contingency Cost', formatCurrencyForPDF(projectData.totals.contingencyCost), projectData.rates.contingencyRate + '%'],
            ['  Overhead Rate', formatCurrencyForPDF(projectData.totals.overheadCost), projectData.rates.overheadRate + '%'],
            ['', '', ''],
            ['GRAND TOTAL (Direct + Indirect)', formatCurrencyForPDF(projectData.totals.grandTotal), ''],
            ['', '', ''],
            ['PROFIT MARGIN', formatCurrencyForPDF(projectData.totals.profitCost), projectData.rates.profitMarginRate + '%'],
            ['', '', ''],
            ['PROJECTED BUDGET', formatCurrencyForPDF(projectData.totals.projectedBudget), '']
        ];
        
        const costWs = XLSX.utils.aoa_to_sheet(costData);
        XLSX.utils.book_append_sheet(wb, costWs, 'Cost Breakdown');
        
        // Create Project Summary sheet
        const summaryData = [
            ['PROJECT SUMMARY'],
            ['Parameter', 'Value'],
            ['Total Boxes', Math.round(projectData.quantities.totalOutlets) + ' boxes'],
            ['Total Labor Hours', formatNumberForPDF(projectData.labor.totalLaborHours, 1) + ' hours'],
            ['Project Duration', formatNumberForPDF(projectData.labor.totalLaborHours / projectData.labor.workHours, 1) + ' days'],
            ['Cost per Box', formatCurrencyForPDF(projectData.totals.costPerBox)],
            ['Crew Size', projectData.labor.crewSize + ' workers'],
            ['Productivity', projectData.labor.productivity + ' boxes/hour/worker'],
            ['Labor Rate', formatCurrencyForPDF(projectData.labor.laborRate) + '/hour'],
            ['Wastage', projectData.rates.wastage + '%']
        ];
        
        const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summaryWs, 'Project Summary');
        
        // Create NEC compliance sheet
        const necData = [
            ['Multi-Wire NEC 314.16 Compliance Details']
        ];
        
        projectData.circuits.forEach(circuit => {
            const nec = circuit.necResult;
            necData.push([`${circuit.description} (${circuit.wireSize} AWG)`]);
            necData.push(['Conductor Size', circuit.wireSize + ' AWG']);
            necData.push(['Current Conductors', circuit.conductors]);
            necData.push(['Pigtails', nec.pigtails]);
            necData.push(['Grounding Conductors', nec.groundingConductors]);
            necData.push(['Devices', circuit.devices]);
            necData.push(['Cable Clamps', circuit.clamps]);
            necData.push(['Volume per Conductor', formatNumberForPDF(nec.volPerConductor, 2) + ' cu. in.']);
            necData.push(['Total Volume Required', formatNumberForPDF(nec.totalVolumeRequired, 2) + ' cu. in.']);
            necData.push(['Safety Factor', nec.safetyFactor + '%']);
            necData.push(['Volume with Safety', formatNumberForPDF(nec.volumeWithSafety, 2) + ' cu. in.']);
            necData.push(['Minimum Required Box', nec.smallestSuitableBox || 'Custom box required']);
            necData.push(['NEC Compliance Status', nec.isCompliant ? 'COMPLIANT' : 'NON-COMPLIANT']);
            necData.push(['']);
        });
        
        // Add NEC adjustments if any
        if (projectData.necAdjustments && projectData.necAdjustments.length > 0) {
            necData.push(['NEC-Driven Adjustments:']);
            projectData.necAdjustments.forEach(adjustment => {
                necData.push([adjustment]);
            });
        }
        
        const necWs = XLSX.utils.aoa_to_sheet(necData);
        XLSX.utils.book_append_sheet(wb, necWs, 'NEC Compliance');
        
        // Save the workbook
        XLSX.writeFile(wb, 'Multi_Wire_Electrical_Estimate_' + projectData.projectName.replace(/\s+/g, '_') + '.xlsx');
    }
    
    // Reset function - UPDATED for new indirect cost fields
    function resetCalculator() {
        if (confirm('Are you sure you want to reset all inputs? This action cannot be undone.')) {
            // Reset form inputs to default values
            document.getElementById('projectName').value = 'Commercial Fit-Out Project';
            document.getElementById('bidNumber').value = 'BID-2024-001';
            document.getElementById('clientName').value = 'ABC Development Corporation';
            document.getElementById('projectLocation').value = 'Makati City, Philippines';
            document.getElementById('preparedBy').value = 'John Smith, Licensed Electrical Engineer';
            document.getElementById('projectDate').valueAsDate = new Date();
            
            document.getElementById('wallArea').value = '250';
            document.getElementById('density').value = '0.6';
            document.getElementById('wastage').value = '10';
            document.getElementById('overheadRate').value = '18';
            document.getElementById('profitMarginRate').value = '22';
            document.getElementById('equipmentCost').value = '8';
            document.getElementById('transportationCost').value = '5';
            
            // Reset new indirect cost fields
            document.getElementById('tempFacilitiesRate').value = '2';
            document.getElementById('powerConsumptionRate').value = '1.5';
            document.getElementById('waterConsumptionRate').value = '0.5';
            document.getElementById('permitsTaxesRate').value = '3';
            document.getElementById('safetyServicesRate').value = '2.5';
            document.getElementById('bondsInsurancesRate').value = '1.5';
            document.getElementById('asBuiltPlansRate').value = '1';
            document.getElementById('deliveryHaulingRate').value = '1.5';
            document.getElementById('contingencyRate').value = '5';
            
            // Reset circuits
            document.getElementById('circuitsContainer').innerHTML = '';
            
            // Reset results with updated 8-column structure
            document.getElementById('billOfQuantity').innerHTML = `
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Unit Cost</th>
                        <th>Material Cost</th>
                        <th>Labor Cost</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5">TOTAL</td>
                        <td id="totalMaterialCost" class="text-right">-</td>
                        <td id="totalLaborCost" class="text-right">-</td>
                        <td id="totalCostColumn" class="text-right">-</td>
                    </tr>
                </tfoot>
            `;
            
            document.getElementById('procurementTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qty Needed</th>
                        <th>Packaging</th>
                        <th>Units to Order</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center">No data calculated yet. Click "Calculate" to generate estimate.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4">TOTAL PROCUREMENT COST</td>
                        <td id="totalProcurementCost" class="text-right">-</td>
                    </tr>
                </tfoot>
            `;
            
            // Reset NEW Cost Breakdown
            document.getElementById('materialCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('laborCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('totalDirectCostDisplay').textContent = 'PHP 0.00';
            
            document.getElementById('equipmentCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('transportationCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('tempFacilitiesCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('powerConsumptionCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('waterConsumptionCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('permitsTaxesCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('safetyServicesCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('bondsInsurancesCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('asBuiltPlansCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('deliveryHaulingCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('contingencyCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('overheadCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('totalIndirectCostDisplay').textContent = 'PHP 0.00';
            
            document.getElementById('grandTotalDisplay').textContent = 'PHP 0.00';
            document.getElementById('profitCostDisplay').textContent = 'PHP 0.00';
            document.getElementById('projectedBudgetDisplay').textContent = 'PHP 0.00';
            
            // Reset project summary
            document.getElementById('totalBoxes').value = '';
            document.getElementById('totalLaborHours').value = '';
            document.getElementById('projectDuration').value = '';
            document.getElementById('costPerBox').value = '';
            
            // Reset circuit summaries
            document.getElementById('circuitSummaryContent').innerHTML = '<p>No circuits defined yet. Add circuits in the Circuit Types tab.</p>';
            document.getElementById('circuitNecResults').innerHTML = '<p>NEC compliance calculations will appear here after circuits are defined and calculated.</p>';
            document.getElementById('circuitResultsSummary').innerHTML = '<p>Circuit breakdown will appear here after calculation.</p>';
            
            // Reset NEC compliance
            document.getElementById('necComplianceSummary').innerHTML = '<p>NEC compliance details will appear here after calculation.</p>';
            document.getElementById('necComplianceWarning').classList.add('hidden');
            
            // Clear validation errors
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            
            // Reset project data
            projectData = {};
            circuitNecResults = {};
            
            // Add default circuit
            addCircuit();
            
            // Update currency displays
            updateCurrencyDisplays();
        }
    }
    
    // Event listeners
    document.getElementById('calculateBtn').addEventListener('click', calculateEstimate);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
    document.getElementById('resetBtn').addEventListener('click', resetCalculator);
    
    // Currency change handler
    document.getElementById('currency').addEventListener('change', function() {
        // Update currency display in results if they exist
        if (document.getElementById('materialCostDisplay').textContent !== 'PHP 0.00') {
            calculateEstimate();
        }
    });
    
    // Initial distribution validation
    validateDistribution();
    
    // Add default circuit on load
    addCircuit();
</script>
</body>
</html>
